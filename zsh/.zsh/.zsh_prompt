#!/bin/bash

# Prompt Colors
        RED="%F{red}"
     YELLOW="%F{yellow}"
      GREEN="%F{green}"
       BLUE="%F{blue}"
     PURPLE="%F{magenta}"
  LIGHT_RED="%F{9}"
LIGHT_GREEN="%F{10}"
      WHITE="%F{white}"
 LIGHT_GRAY="%F{15}"
 COLOR_NONE="%f"
     BG_RED="%K{red}"
    BG_BLUE="%K{blue}"
    BG_NONE="%k"

USER_COLOR="$GREEN"
PATH_COLOR="$YELLOW"
BRANCH_COLOR="$RED"

# determine git branch name
function parse_git_branch(){
    if [ -d .git ] || git rev-parse --git-dir > /dev/null 2>&1 ; then
        git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/'
    fi
}

# Determine the branch/state information for this git repository.
function set_git_branch() {
    local branch=$(parse_git_branch)
    [[ -z "$branch" ]] && { BRANCH=""; return; }

    local ellipsis_utf8
    local -i maxlen

    ellipsis_utf8=$'\u2026'
    maxlen=18

    if [[ "${#branch}" -gt $maxlen ]]; then
      branch="${branch:0:$maxlen}${ellipsis_utf8}"
    fi

    BRANCH="$branch"
}

# Return the prompt symbol to use, colorized based on the return value of the
# previous command.
function set_prompt_symbol () {
    SYMBOL="Î»"

    if test -n "$SSH_TTY" || test -n "$SSH_CLIENT" ; then
        SYMBOL="$"
    fi

    if [[ `whoami` == "root" ]] ; then
        SYMBOL="#"
    fi

    if test $1 -eq 0 ; then
        PROMPT_SYMBOL=$SYMBOL
    else
        PROMPT_SYMBOL="${LIGHT_RED}${SYMBOL}${COLOR_NONE}"
    fi
}

# Set the hostname, highlighting the background if in ssh
function set_host () {
    P_HOST=%m
    if test -n "$SSH_TTY" || test -n "$SSH_CLIENT" ; then
        P_HOST="${BG_BLUE}${WHITE}${P_HOST}${COLOR_NONE}${BG_NONE}"
    fi
}

# Set the username and the hostname
function set_user () {
    P_USER=`whoami`
    P_USER="${P_USER}@"
    if [[ ${P_USER} == "root@" ]] ; then
        P_USER="${BG_RED}${WHITE}${P_USER}${COLOR_NONE}${BG_NONE}"
    fi
}

# Set the full bash prompt.
function set_prompt () {
    set_prompt_symbol $?
    set_host
    set_user
    set_git_branch

    PATH_SH=%~

    # Set the bash prompt variable.
    PS1=$(printf "\n%s:%s\n%s %s " \
      "${USER_COLOR}${P_USER}${P_HOST}${COLOR_NONE}" \
      "${PATH_COLOR}${PATH_SH}${COLOR_NONE}" \
      "${BRANCH_COLOR}{${BRANCH}}${COLOR_NONE}" \
      "${PROMPT_SYMBOL}"
    )
}

PROMPT_COMMAND=set_prompt
